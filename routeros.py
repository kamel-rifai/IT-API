import routeros_api
from collections import defaultdict
connection = routeros_api.RouterOsApiPool('192.168.130.4', 'admin', '555288', plaintext_login=True)
api = connection.get_api()
resource = api.get_resource('/interface/bridge/host')
all_hosts = resource.get()
# Group MACs by port
MAC_DEVICES = [
    "00:30:4F:BD:1B:5F",
    "00:30:4F:BD:1B:62",
    "00:30:4F:BD:1B:65",
    "00:30:4F:BD:C8:BF",
    "00:30:4F:BD:C8:C5",
    "00:30:4F:BD:C9:E2",
    "00:30:4F:BD:C9:E4",
    "00:30:4F:BD:CA:B2",
    "00:30:4F:BD:CA:B3",
    "00:30:4F:BD:CA:B4",
    "00:30:4F:BD:CA:B5",
    "00:30:4F:BD:CA:B6",
    "00:30:4F:BD:CA:B7",
    "00:30:4F:BD:CA:B8",
    "00:30:4F:BD:CA:B9",
    "00:30:4F:BD:CA:BA",
    "00:30:4F:BD:CA:BB",
    "00:30:4F:BD:CA:EE",
    "00:30:4F:BD:CA:EF",
    "00:30:4F:BD:CA:F0",
    "00:30:4F:BD:CA:F1",
    "00:30:4F:BD:CA:F2",
    "00:30:4F:BD:CA:F3",
    "00:30:4F:BD:CA:F4",
    "00:30:4F:BD:CA:F5",
    "00:30:4F:BD:CA:F6",
    "00:30:4F:BD:CA:F7",
    "00:A8:59:F0:D4:1C",
    "00:A8:59:F0:D4:4C",
    "00:A8:59:F0:D4:5E",
    "00:A8:59:F0:D4:60",
    "00:A8:59:F0:D4:61",
    "00:A8:59:F0:D4:64",
    "00:A8:59:F0:DA:0C",
    "02:04:A3:00:61:13",
    "02:04:A3:00:61:17",
    "02:04:A3:00:61:20",
    "02:04:A3:00:61:26",
    "02:04:A3:00:61:2B",
    "02:04:A3:00:61:2C",
    "02:04:A3:00:61:4D",
    "02:04:A3:00:61:59",
    "02:04:A3:00:61:5F",
    "02:04:A3:00:61:6C",
    "02:04:A3:00:61:6E",
    "02:04:A3:00:61:73",
    "02:04:A3:00:61:74",
    "02:04:A3:00:61:75",
    "02:04:A3:00:61:76",
    "02:04:A3:00:61:7B",
    "02:04:A3:00:A0:86",
    "02:04:A3:00:A0:87",
    "02:04:A3:00:A0:88",
    "02:04:A3:00:A0:8A",
    "02:04:A3:00:A0:8B",
    "02:04:A3:00:A0:8D",
    "02:04:A3:00:A0:8E",
    "02:04:A3:00:A0:8F",
    "02:04:A3:00:A0:90",
    "02:04:A3:00:A0:91",
    "02:04:A3:00:A0:92",
    "02:04:A3:00:A0:93",
    "02:04:A3:00:A0:94",
    "02:04:A3:00:A0:95",
    "02:04:A3:00:A3:9C",
    "02:04:A3:00:A3:9D",
    "02:04:A3:00:A4:6F",
    "02:04:A3:00:A4:70",
    "02:04:A3:00:A4:71",
    "02:04:A3:00:A4:72",
    "02:04:A3:00:A4:75",
    "02:04:A3:00:A4:78",
    "02:04:A3:00:A4:7A",
    "02:04:A3:00:A4:7B",
    "02:04:A3:00:A4:7C",
    "02:04:A3:00:A4:7E",
    "02:04:A3:00:A4:7F",
    "02:04:A3:00:A4:81",
    "02:A4:A3:01:03:E0",
    "02:A4:A3:01:03:E4",
    "02:A4:A3:01:03:E7",
    "02:A4:A3:01:03:EF",
    "02:A4:A3:01:03:F1",
    "02:A4:A3:01:03:F3",
    "02:A4:A3:01:03:F6",
    "02:A4:A3:01:03:F7",
    "02:A4:A3:01:03:FF",
    "02:A4:A3:01:04:01",
    "02:A4:A3:01:04:02",
    "02:A4:A3:01:04:03",
    "02:A4:A3:01:04:04",
    "02:A4:A3:01:04:05",
    "02:A4:A3:01:04:07",
    "02:A4:A3:01:04:08",
    "02:A4:A3:01:04:09",
    "02:A4:A3:01:04:0B",
    "02:A4:A3:01:04:0C",
    "02:A4:A3:01:04:0D",
    "02:A4:A3:01:04:0E",
    "02:A4:A3:01:04:0F",
    "02:A4:A3:01:04:10",
    "02:A4:A3:01:04:12",
    "02:A4:A3:01:04:13",
    "02:A4:A3:01:04:14",
    "02:A4:A3:01:04:15",
    "02:A4:A3:01:04:16",
    "02:A4:A3:01:04:17",
    "02:A4:A3:01:04:19",
    "02:A4:A3:01:04:1A",
    "02:A4:A3:01:04:1B",
    "02:A4:A3:01:04:1C",
    "02:A4:A3:01:04:1D",
    "02:A4:A3:01:04:1E",
    "02:A4:A3:01:04:1F",
    "02:A4:A3:01:04:20",
    "02:A4:A3:01:04:21",
    "02:A4:A3:01:04:22",
    "02:A4:A3:01:04:23",
    "02:A4:A3:01:04:24",
    "02:A4:A3:01:04:26",
    "02:A4:A3:01:04:27",
    "02:A4:A3:01:04:28",
    "0C:38:3E:13:0A:67",
    "0C:38:3E:13:0A:69",
    "0C:38:3E:2D:E9:3E",
    "0C:38:3E:2D:E9:42",
    "0C:38:3E:2D:E9:45",
    "0C:38:3E:31:DE:E5",
    "0C:38:3E:31:DE:E7",
    "0C:38:3E:31:DE:EB",
    "0C:38:3E:33:70:69",
    "0C:38:3E:33:71:0E",
    "0C:38:3E:33:71:32",
    "0C:38:3E:33:71:58",
    "0C:38:3E:33:71:59",
    "0C:38:3E:33:71:9F",
    "0C:38:3E:33:71:AC",
    "0C:38:3E:33:71:B1",
    "0C:38:3E:33:72:00",
    "0C:38:3E:33:72:A3",
    "0C:38:3E:33:73:0A",
    "0C:38:3E:33:73:6B",
    "0C:38:3E:33:73:81",
    "0C:38:3E:33:73:88",
    "0C:38:3E:33:74:70",
    "0C:38:3E:33:74:7E",
    "0C:38:3E:33:74:C2",
    "0C:38:3E:33:75:11",
    "0C:38:3E:33:75:12",
    "0C:38:3E:33:75:13",
    "0C:38:3E:33:75:16",
    "0C:38:3E:33:75:18",
    "0C:38:3E:33:75:19",
    "0C:38:3E:33:75:1A",
    "0C:38:3E:33:75:1B",
    "0C:38:3E:33:75:1E",
    "0C:38:3E:33:75:6D",
    "0C:38:3E:33:75:AA",
    "0C:38:3E:33:75:AC",
    "0C:38:3E:33:75:BE",
    "0C:38:3E:33:75:C6",
    "0C:38:3E:33:75:E6",
    "0C:38:3E:33:75:E8",
    "0C:38:3E:33:75:F4",
    "0C:38:3E:33:75:F6",
    "0C:38:3E:33:75:F9",
    "0C:38:3E:58:F9:58",
    "0C:38:3E:58:FA:58",
    "0C:38:3E:58:FB:34",
    "0C:38:3E:58:FB:46",
    "0C:38:3E:58:FC:5A",
    "0C:38:3E:58:FC:F2",
    "0C:38:3E:58:FE:86",
    "0C:38:3E:6E:CB:1C",
    "0C:38:3E:6E:CC:DB",
    "0C:38:3E:6E:CD:01",
    "0C:38:3E:6F:4C:44",
    "30:DD:AA:61:A1:15",
    "30:DD:AA:61:A1:20",
    "30:DD:AA:61:A1:C5",
    "30:DD:AA:61:A1:D1",
    "30:DD:AA:61:A5:DB",
    "98:4A:6B:5F:BF:E4",
    "C0:74:AD:CD:94:B6",
    "C0:74:AD:CD:94:B9",
    "C0:74:AD:CD:95:01",
    "C0:74:AD:CD:95:69",
    "C0:74:AD:CD:95:82",
    "C0:74:AD:D7:5C:CC",
    "C0:74:AD:D7:5D:64",
    "C0:74:AD:D7:5D:70",
    "C0:74:AD:D7:5D:B8",
    "C0:74:AD:D7:5E:48",
    "C0:74:AD:D7:62:E8",
    "C0:74:AD:D7:63:00",
    "C0:74:AD:D7:63:04",
    "C0:74:AD:D7:63:08",
    "C0:74:AD:D7:63:0C",
    "C0:74:AD:D7:63:20",
    "C0:74:AD:D7:63:2C",
    "C0:74:AD:D7:63:34",
    "C0:74:AD:D7:63:38",
    "C0:74:AD:D7:63:3C",
    "C0:74:AD:D7:63:54",
    "C0:74:AD:D7:74:40",
    "C0:74:AD:D7:74:88",
    "C0:74:AD:D9:81:B2",
    "C0:74:AD:D9:81:BC",
    "C0:74:AD:D9:81:D7",
    "C0:74:AD:D9:81:DD",
    "C0:74:AD:D9:81:E6",
    "C0:74:AD:D9:81:ED",
    "C0:74:AD:D9:82:62",
    "C0:74:AD:D9:82:EA",
    "C0:74:AD:D9:83:09",
    "C0:74:AD:D9:83:0B",
    "C0:74:AD:D9:83:15",
    "C0:74:AD:D9:83:16",
    "C0:74:AD:D9:83:17",
    "C0:74:AD:D9:83:18",
    "C0:74:AD:D9:83:19",
    "C0:74:AD:D9:83:1C",
    "C0:74:AD:D9:83:1D",
    "C0:74:AD:D9:83:25",
    "C0:74:AD:D9:83:27",
    "C0:74:AD:D9:83:29",
    "C0:74:AD:D9:83:2B",
    "C0:74:AD:D9:83:2C",
    "C0:74:AD:D9:83:2D",
    "C0:74:AD:D9:83:2F",
    "C0:74:AD:D9:83:3D",
    "C0:74:AD:D9:83:45",
    "C0:74:AD:D9:83:49",
    "C0:74:AD:D9:83:4D",
    "C0:74:AD:D9:83:4F",
    "C0:74:AD:D9:83:51",
    "C0:74:AD:D9:83:55",
    "C0:74:AD:D9:83:56",
    "C0:74:AD:D9:83:58",
    "C0:74:AD:D9:83:59",
    "C0:74:AD:D9:83:5E",
    "C0:74:AD:D9:83:61",
    "C0:74:AD:D9:83:64",
    "C0:74:AD:D9:83:66",
    "C0:74:AD:D9:83:6A",
    "C0:74:AD:D9:83:6B",
    "C0:74:AD:D9:83:72",
    "C0:74:AD:D9:83:73",
    "C0:74:AD:D9:83:74",
    "C0:74:AD:D9:83:76",
    "C0:74:AD:D9:83:7B",
    "C0:74:AD:D9:83:7C",
    "C0:74:AD:D9:83:7F",
    "C0:74:AD:D9:83:8B",
    "C0:74:AD:D9:83:97",
    "C0:74:AD:D9:83:98",
    "C0:74:AD:D9:83:9F",
    "C0:74:AD:D9:83:C2",
    "C0:74:AD:D9:83:C3",
    "C0:74:AD:D9:83:D1",
    "C0:74:AD:D9:83:D7",
    "C0:74:AD:D9:83:D8",
    "C0:74:AD:D9:83:E9",
    "C0:74:AD:D9:83:EA",
    "C0:74:AD:D9:83:F2",
    "C0:74:AD:D9:83:F5",
    "C0:74:AD:D9:83:FB",
    "C0:74:AD:D9:83:FF",
    "C0:74:AD:D9:84:05",
    "C0:74:AD:D9:84:14",
    "C0:74:AD:D9:84:2A",
    "C0:74:AD:D9:84:2D",
    "C0:74:AD:D9:84:4B",
    "C0:74:AD:D9:84:55",
    "C0:74:AD:D9:84:6C",
    "C0:74:AD:D9:84:6D",
    "C0:74:AD:D9:84:6E",
    "C0:74:AD:D9:84:6F",
    "C0:74:AD:D9:84:71",
    "C0:74:AD:D9:84:72",
    "C0:74:AD:D9:84:74",
    "C0:74:AD:D9:84:75",
    "C0:74:AD:D9:84:77",
    "C0:74:AD:D9:84:7F",
    "C0:74:AD:D9:84:83",
    "C0:74:AD:D9:84:89",
    "C0:74:AD:D9:84:94",
    "C0:74:AD:D9:84:95",
    "C0:74:AD:D9:84:96",
    "C0:74:AD:D9:84:98",
    "C0:74:AD:D9:84:AA",
    "C0:74:AD:D9:84:AC",
    "C0:74:AD:D9:84:B1",
    "C0:74:AD:D9:84:D4",
    "C0:74:AD:D9:85:00",
    "C0:74:AD:D9:85:04",
    "C0:74:AD:D9:85:21",
    "C0:74:AD:D9:85:3B",
    "C0:74:AD:EC:3C:F8",
    "C0:74:AD:EC:3D:2C",
    "C0:74:AD:EC:3D:30",
    "C0:74:AD:EC:3D:3C",
    "C0:74:AD:EC:3D:44",
    "C0:74:AD:EC:3D:48",
    "C0:74:AD:F3:D0:24",
    "C0:74:AD:F3:D7:3C",
    "D4:43:0E:06:21:A7",
    "D4:43:0E:06:22:A2",
    "D4:43:0E:06:22:AA",
    "D4:43:0E:06:22:C7",
    "D4:43:0E:06:23:1B",
    "D4:43:0E:06:23:1E",
    "D4:43:0E:06:23:34",
    "D4:43:0E:06:23:76",
    "D4:43:0E:06:23:9B",
    "D4:43:0E:06:23:AF",
    "D4:43:0E:06:23:C6",
    "D4:43:0E:06:23:DB",
    "D4:43:0E:06:23:E3",
    "D4:43:0E:06:23:EA",
    "D4:43:0E:06:23:EC",
    "D4:43:0E:06:23:EE",
    "D4:43:0E:06:23:F1",
    "D4:43:0E:06:23:F3",
    "D4:43:0E:06:23:F7",
    "D8:38:0D:41:A6:68",
    "D8:38:0D:41:A6:B0",
    "D8:38:0D:41:A8:60",
    "D8:38:0D:41:A9:08",
    "E4:24:6C:A1:8C:2C",
    "E4:24:6C:A1:8C:83",
    "EC:74:D7:04:B1:B1",
    "EC:74:D7:04:B1:BA",
    "EC:74:D7:04:B1:BB",
    "EC:74:D7:04:B1:C1",
    "EC:74:D7:04:B1:C2",
    "EC:74:D7:04:B1:C5",
    "EC:74:D7:04:B1:C8",
    "EC:74:D7:11:C3:0F",
    "EC:74:D7:11:C3:13",
    "EC:74:D7:11:C3:1A",
    "EC:74:D7:11:C3:1C",
    "EC:74:D7:11:C3:28",
    "EC:74:D7:11:C3:29",
    "EC:74:D7:11:C3:2C",
    "EC:74:D7:11:C3:2D",
    "F4:B1:C2:87:6B:55",
    "F4:B1:C2:87:6B:5E",
    "F4:B1:C2:87:6B:60",
    "F4:B1:C2:87:6B:64",
    "F4:B1:C2:87:6C:62",
    "F4:B1:C2:87:6C:64",
    "F4:B1:C2:87:6E:7C",
    "F4:B1:C2:87:6E:A0",
    "F4:B1:C2:87:6E:A1",
    "F4:B1:C2:87:6E:A6",
    "F4:B1:C2:87:6E:B4",
    "F4:B1:C2:87:6E:B5",
    "F4:B1:C2:87:6F:CB",
    "F4:B1:C2:87:6F:FB",
    "F4:B1:C2:87:70:43",
    "F4:B1:C2:87:70:4D",
    "F4:B1:C2:87:70:4F",
    "F4:B1:C2:87:70:54",
    "F4:B1:C2:87:70:D9",
    "F4:B1:C2:87:71:03",
    "F4:B1:C2:87:7E:09",
    "F4:B1:C2:87:7E:0D",
    "F4:B1:C2:87:7E:2C",
    "F4:B1:C2:87:7E:36",
    "F4:B1:C2:87:7E:52",
    "F4:B1:C2:87:7E:58",
    "F4:B1:C2:87:7E:5B",
    "F4:B1:C2:87:7E:5C",
    "F4:B1:C2:87:7E:5D",
    "F4:B1:C2:87:80:FC",
    "F4:B1:C2:87:81:29",
    "F4:B1:C2:87:81:57",
    "F4:B1:C2:87:81:5C",
    "F4:B1:C2:87:81:75",
    "F4:B1:C2:87:81:77",
    "F4:B1:C2:87:81:78",
    "F4:B1:C2:87:81:79",
    "F4:B1:C2:87:81:7D",
    "F4:B1:C2:87:81:7E",
    "F4:B1:C2:87:81:81",
    "F4:B1:C2:97:E3:07",
    "F4:B1:C2:97:E3:0B",
    "F4:B1:C2:97:E3:11",
    "F4:B1:C2:97:E3:12",
    "F4:B1:C2:97:E3:18",
    "F4:B1:C2:97:E3:23",
    "F4:B1:C2:97:E3:29",
    "F4:B1:C2:97:E3:30",
    "F4:B1:C2:97:E3:44",
    "F4:B1:C2:97:E3:49",
    "F4:B1:C2:97:E3:4A",
    "F4:B1:C2:97:E3:54",
    "F4:B1:C2:97:E3:56",
    "F4:B1:C2:97:E3:6A",
    "F4:B1:C2:97:E3:6D",
    "F4:B1:C2:97:E3:77",
    "F4:B1:C2:97:E3:7A",
    "F4:B1:C2:97:E3:BE",
    "F4:B1:C2:97:E3:C2",
    "F4:B1:C2:97:E3:D0",
    "F4:B1:C2:97:E3:D3",
    "F4:B1:C2:97:E3:D8",
    "F4:B1:C2:97:E3:DA",
    "F4:B1:C2:97:E3:E4",
    "F4:B1:C2:97:E3:F4",
    "F4:B1:C2:97:E4:03",
    "F4:B1:C2:97:E4:0D",
    "F4:B1:C2:97:E4:0F",
    "F4:B1:C2:97:E4:15",
    "F4:B1:C2:97:E4:1F",
    "F4:B1:C2:97:E4:28",
    "F4:B1:C2:97:E4:30",
    "F4:B1:C2:97:E4:33",
    "F4:B1:C2:97:E4:4F",
    "F4:B1:C2:97:E4:68",
    "FC:5F:49:EB:59:8E",
    "FC:5F:49:EB:59:90",
    "FC:5F:49:EB:59:93",
    "FC:5F:49:EB:59:94",
    "FC:5F:49:EB:59:95",
    "FC:5F:49:EB:59:98",
    "FC:5F:49:EB:59:9B",
    "FC:5F:49:EB:59:9E",
    "FC:5F:49:EB:59:A0",
    "FC:5F:49:EB:59:A5",
    "FC:5F:49:EB:59:A8",
    "FC:B6:9D:67:6F:9C",
    "FC:B6:9D:67:6F:E5",
    "FC:B6:9D:67:6F:EB",
    "FC:B6:9D:67:70:2C",
    "FC:B6:9D:67:70:30",
    "FC:B6:9D:67:70:B3",
    "FC:B6:9D:67:70:C4",
    "FC:B6:9D:67:70:E2",
    "FC:B6:9D:67:71:4A",
    "FC:B6:9D:67:71:4D",
    "FC:B6:9D:67:71:6C",
    "FC:B6:9D:67:71:7B",
    "FC:B6:9D:67:71:7C",
    "FC:B6:9D:67:71:90",
    "FC:B6:9D:67:71:9B",
    "FC:B6:9D:D3:BF:B7",
    "FC:B6:9D:D3:BF:C7",
    "FC:B6:9D:D3:BF:D4",
    "FC:B6:9D:D3:BF:D6",
    "FC:B6:9D:D3:BF:E6",
    "FC:B6:9D:D3:C1:C5",
    "FC:B6:9D:D3:C1:D5",
    "FC:B6:9D:D3:C1:E0",
    "FC:B6:9D:D3:C1:E3",
    "FC:B6:9D:D3:C1:E5",
    "FC:B6:9D:D3:C1:EF",
]
resource = api.get_resource('/interface/bridge/host')
all_hosts = resource.get()
#print(all_hosts)
# Group MACs by port
port_map = defaultdict(list)
#print(len(MAC_DEVICES), "unconnected devices with MACs to check against.")
for entry in all_hosts:
    # 'on-interface' is the key field in /interface/bridge/host
    port = entry.get('on-interface').strip("ether") if entry.get('on-interface') and entry.get('on-interface').startswith('ether') else None
    mac = entry.get('mac-address')
    # Skip entries missing port or mac
    if not port or not mac:
        print("here")
        continue
    # Ignore MACs that start with D4:01:C3 (case-insensitive)
    print(mac)
    if port.startswith('sfp') or (mac.upper().startswith('D4:01:C3') or mac.upper().startswith('18:FD:74') or mac.upper().startswith('C4:AD:34') or mac.upper().startswith("74:4D:28") or mac.upper().startswith("48:8F:5A")) :
        continue
    else:
        port_map[port].append(mac)
print(port_map)
for port, macs in port_map.items():
    if len(macs) == 1:
        # Find the port object
        print(f"Port {port} has a SINGLE device connected: {macs[0]}")

    else:
        print(f"Port {port} is an UPLINK/SWITCH (sees {macs} devices)")
print(len(port_map), "ports with connected devices found.")